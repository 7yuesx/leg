import scipy.io
import numpy as np

# 加载文件
data = scipy.io.loadmat('sys_matrices.mat')

# 提取矩阵 (注意：loadmat 返回的是字典)


n = 1000

z = np.zeros((n, 14, 1))
u = np.zeros((n, 6, 1))
u_best = np.zeros((n, 6, 1))

P = np.zeros((n, 14, 14))
F = np.zeros((n, 6, 14))
S = np.array(
            [[1,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,1,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,1,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,1,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,1,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,1,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,1,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,1,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,1,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,1,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,1,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,1]])
Q = np.array(
            [[1,0,0,0,0,0,0,0,0,0,0,0,0,0],
             [0,1,0,0,0,0,0,0,0,0,0,0,0,0],
             [0,0,1,0,0,0,0,0,0,0,0,0,0,0],
             [0,0,0,1,0,0,0,0,0,0,0,0,0,0],
             [0,0,0,0,1,0,0,0,0,0,0,0,0,0],
             [0,0,0,0,0,1,0,0,0,0,0,0,0,0],
             [0,0,0,0,0,0,1,0,0,0,0,0,0,0],
             [0,0,0,0,0,0,0,1,0,0,0,0,0,0],
             [0,0,0,0,0,0,0,0,1,0,0,0,0,0],
             [0,0,0,0,0,0,0,0,0,1,0,0,0,0],
             [0,0,0,0,0,0,0,0,0,0,1,0,0,0],
             [0,0,0,0,0,0,0,0,0,0,0,1,0,0],
             [0,0,0,0,0,0,0,0,0,0,0,0,1,0],
             [0,0,0,0,0,0,0,0,0,0,0,0,0,1]])
R = np.array(
            [[1,0,0,0,0,0],
             [0,1,0,0,0,0],
             [0,0,1,0,0,0],
             [0,0,0,1,0,0],
             [0,0,0,0,1,0],
             [0,0,0,0,0,1]])

J = np.zeros(n)
J_best = np.zeros(n)

A = data['A']
B = data['B']
C = data['C']
D = data['D']
print("A matrix shape:", A.shape)
print(A)
# P[n-1] = S
# J[n-1] = 1/2 * z[n-1].T @ P[n-1] @ z[n-1] 
# J_best[n-1]=1/2*(z[n-1].T @ P[n-1] @ z[n-1])

# J[n-2] = 1/2 * (A @ z[n-2] + B @ u[n-2]).T @ P[n-1] @ (A @ z[n-2] + B @ u[n-2]) + 1/2 * z[n-2].T @ Q @ z[n-2] + 1/2 * u[n-2].T @ R @ u[n-2]
# F[n-1] = np.linalg.inv(B.T @ P[n-1] @ B + R) @ B.T @ P[n-1] @ A
# u_best[n-1] = -F[n-1] @ z[n-1]
# P[n-2]=(A-B@F[n-1]).T @ P[n-1] @ (A-B@F[n-1])+F[n-1].T @ R @ F[n-1]+Q
# J_best[n-2]=1/2*(z[n-2].T @ P[n-2] @ z[n-2])

def solve_riccati(A, B, Q, R, S, n=1000, tol=1e-6):
    P[n-1] = S
    F[n-1] = np.linalg.inv(B.T @ P[n-1] @ B + R) @ B.T @ P[n-1] @ A
    for i in range(n-2, -1, -1):
        P[i]=(A-B@F[i+1]).T @ P[i+1] @ (A-B@F[i+1])+F[i+1].T @ R @ F[i+1]+Q
        F[i] = np.linalg.inv(B.T @ P[i] @ B + R) @ B.T @ P[i] @ A

        # 计算差值矩阵
        diff = P[i] - P[i+1]
        
        # 计算范数

        diff_norm = np.linalg.norm(P[i] - P[i+1], 'fro')
        ref_norm = np.linalg.norm(P[i+1], 'fro')
            
        if ref_norm < 1e-15:
            error = diff_norm  # 绝对误差
        else:
            error = diff_norm / ref_norm  # 相对误差
            
            # 4. 检查收敛
        if error < tol:
            print(f"收敛于迭代 {n-i-1}, 误差 = {error:.2e}")
            print(f"稳态P =\n{P[i]}")
            print(f"稳态F =\n{F[i]}")
            return P[i], F[i], True, i
        
        if i==0:
            print("错误: 未收敛")
            return None, None, False, i
    
[P_convergence,F_convergence,bool,number]=solve_riccati(A, B, Q, R, S) 

# [[ 0.00000000e+00  0.00000000e+00  0.00000000e+00  5.12038007e-01
#    0.00000000e+00  8.31093064e+01 -6.67346454e+01  0.00000000e+00
#    0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
#    0.00000000e+00  0.00000000e+00]
#  [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  5.12038007e-01
#    0.00000000e+00  8.31093064e+01 -6.67346454e+01  0.00000000e+00
#    0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
#    0.00000000e+00  0.00000000e+00]
#  [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  6.62783498e-02
#    0.00000000e+00 -9.02150617e+00  1.13614240e+01  0.00000000e+00
#    0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
#    0.00000000e+00  0.00000000e+00]
#  [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  5.51959540e-01
#    0.00000000e+00  6.10573625e+01 -4.54732687e+01  0.00000000e+00
#    0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
#    0.00000000e+00  0.00000000e+00]
#  [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  5.51959540e-01
#    0.00000000e+00  6.10573625e+01 -4.54732687e+01  0.00000000e+00
#    0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
#    0.00000000e+00  0.00000000e+00]
#  [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  2.58786053e-01
#    0.00000000e+00 -8.51288813e+00  1.08134667e+01  0.00000000e+00
#    0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
#    0.00000000e+00  0.00000000e+00]]
